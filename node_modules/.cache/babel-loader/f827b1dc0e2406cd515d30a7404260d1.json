{"ast":null,"code":"/* eslint-disable no-unused-vars */\nimport { ElMessage } from \"element-plus\";\nimport RobotOperation from \"./RobotOperation.vue\";\nimport { getMapList, switchMap, getMapInfo, getPositions, registerCallbackApi } from \"@/service/map\";\nimport { getRobotInfoApi, robotNavigationApi } from \"@/service/robot\";\nexport default {\n  name: \"MapDashboard\",\n  // eslint-disable-next-line vue/no-unused-components\n  components: {\n    RobotOperation\n  },\n\n  data() {\n    return {\n      dialogVisible: false,\n      selectedPosition: \"\",\n      defaultMap: require(\"@/assets/images/defaulmap.jpg\"),\n      logo: require(\"@/assets/logo.png\"),\n      robotLogo: require(\"@/assets/images/robot.png\"),\n      canvasWidth: 1000,\n      //1200\n      canvasHeight: 500,\n      //600\n      count: 0,\n      // 用来记录机器人的位置是否连续5次一样，5次一样的话停止轮询\n      mapList: [],\n      currentMap: \"\",\n      mapLoading: false,\n      mapInfo: {},\n      positionsList: [],\n      robotInfo: {},\n      positionType: {\n        NAV_POS_TYPE: \"导航点位\",\n        PARK_POS_TYPE: \"停车点位\",\n        CHARGE_POS_TYPE: \"充电点位\",\n        ACTION_POS_TYPE: \"工作点位\"\n      },\n      canvasCtx: \"\"\n    };\n  },\n\n  methods: {\n    changeMap() {\n      this.dialogVisible = true;\n    },\n\n    comfireModel() {\n      //确认切换地图\n      this.getMapInfo(this.currentMap);\n    },\n\n    startPolling() {\n      this.polling = setInterval(() => {\n        this.getMapInfo(this.currentMap);\n      }, 3000); // 3秒查询一次\n    },\n\n    async onNavClick() {\n      if (this.selectedPosition) {\n        const res = await robotNavigationApi({\n          destPosition: this.selectedPosition,\n          cmd: 0\n        });\n        const {\n          data,\n          code\n        } = res; // this.currentNavRequestId = data.requestId;\n\n        if (code === 0) {\n          ElMessage({\n            message: `导航开始，当前目标点：${this.positionsList.find(i => i.id === this.selectedPosition).type}`,\n            type: \"success\"\n          });\n          this.startPolling();\n        }\n      } else {\n        ElMessage({\n          message: `请先选择一个导航点`,\n          type: \"warning\"\n        });\n      }\n    },\n\n    async getCurrentRobotInfo() {\n      const {\n        data\n      } = await getRobotInfoApi();\n      this.robotInfo = data;\n\n      if (data.map === this.currentMap) {\n        const {\n          x,\n          y\n        } = this.calculatePointPosition(data.x, data.y); // 渲染机器人位置\n\n        this.drawPoint(this.robotInfo.robotId, this.robotLogo, x, y, 40);\n      }\n    },\n\n    async getMapList() {\n      const {\n        data\n      } = await getMapList();\n      console.log(\"data\", data);\n      this.mapList = data.mapList;\n      this.currentMap = data.currentMap;\n    },\n\n    async getMapInfo(mapName) {\n      const {\n        data\n      } = await getMapInfo({\n        mapName,\n        containPixelData: false\n      });\n      console.log(\"MapInfo\", data);\n      this.mapInfo = data; // 获取到地图数据后渲染地图和相关位置点\n\n      if (this.mapList.length > 0) {\n        this.drawMap(data.mapFile, () => {\n          this.getMapPositions();\n        });\n      }\n    },\n\n    async getMapPositions() {\n      const {\n        data\n      } = await getPositions();\n      this.positionsList = data.posArray;\n      this.getCurrentRobotInfo();\n      data.posArray.forEach(item => {\n        const {\n          x,\n          y\n        } = this.calculatePointPosition(item.x, item.y); // 渲染地图上的点\n\n        this.drawPoint(this.positionType[item.type], this.logo, x, y, 20);\n      });\n    },\n\n    getCanvasCtx() {\n      const map = document.getElementById(\"map\");\n      const ctx = map.getContext(\"2d\");\n      this.canvasCtx = ctx;\n    },\n\n    clearCanvas() {\n      // TODO 目前是清空整个canvas重绘 后续可以针对某个点清空重绘？\n      this.canvasCtx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);\n    },\n\n    drawMap(mapUrl, onImageLoadCallback) {\n      const img = new Image();\n      img.src = mapUrl; //  加载图片\n\n      img.onload = () => {\n        if (img.complete) {\n          this.canvasCtx.drawImage(img, 0, 0, this.canvasWidth, this.canvasHeight);\n\n          if (onImageLoadCallback) {\n            onImageLoadCallback();\n          }\n        }\n      };\n    },\n\n    async onMapSWitchClick(map) {\n      const {\n        code\n      } = await switchMap({\n        mapName: map\n      });\n\n      if (code === 0) {\n        this.currentMap = map;\n      }\n    },\n\n    calculatePointPosition(x, y) {\n      // 给的是地图左下角的点，canvas原点在左上角\n      const origin = {\n        x: this.mapInfo.leftBottomX,\n        y: this.mapInfo.leftBottomY - this.mapInfo.height\n      }; // 缩放倍数\n\n      const zoomScale = {\n        x: this.canvasWidth / this.mapInfo.width,\n        y: this.canvasHeight / this.mapInfo.height\n      };\n      return {\n        x: (x - origin.x) * zoomScale.x,\n        y: (y - origin.y) * zoomScale.y\n      };\n    },\n\n    drawPoint(text, logoUrl, x, y, dottedSize) {\n      const img = new Image();\n      img.src = logoUrl; //  加载图片\n\n      img.onload = () => {\n        if (img.complete) {\n          this.canvasCtx.drawImage(img, x, y, dottedSize, dottedSize);\n          this.canvasCtx.font = \"12px bold 黑体\";\n          this.canvasCtx.fillText(text, x + dottedSize, y + dottedSize); // if (onImageLoadCallback) {\n          //   onImageLoadCallback();\n          // }\n        }\n      };\n    }\n\n  },\n\n  mounted() {\n    registerCallbackApi({\n      robotStatus: \"/robotStatus\",\n      resultNotify: \"/resultNotify\"\n    });\n    this.getMapList();\n    this.getCanvasCtx();\n    this.drawMap(this.defaultMap);\n  },\n\n  watch: {\n    currentMap(newVal) {\n      this.getMapInfo(newVal);\n    },\n\n    robotInfo(newVal, oldVal) {\n      // 如果位置五次都一样，停止轮询\n      if (newVal.x === oldVal.x && newVal.y === oldVal.y) {\n        this.count += 1;\n\n        if (this.count > 5) {\n          clearInterval(this.polling);\n          this.polling = null;\n        }\n      }\n    }\n\n  }\n};","map":{"version":3,"mappings":"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","names":["ElMessage","RobotOperation","getMapList","switchMap","getMapInfo","getPositions","registerCallbackApi","getRobotInfoApi","robotNavigationApi","name","components","data","dialogVisible","selectedPosition","defaultMap","require","logo","robotLogo","canvasWidth","canvasHeight","count","mapList","currentMap","mapLoading","mapInfo","positionsList","robotInfo","positionType","NAV_POS_TYPE","PARK_POS_TYPE","CHARGE_POS_TYPE","ACTION_POS_TYPE","canvasCtx","methods","changeMap","comfireModel","startPolling","polling","setInterval","onNavClick","res","destPosition","cmd","code","message","find","i","id","type","getCurrentRobotInfo","map","x","y","calculatePointPosition","drawPoint","robotId","console","log","mapName","containPixelData","length","drawMap","mapFile","getMapPositions","posArray","forEach","item","getCanvasCtx","document","getElementById","ctx","getContext","clearCanvas","clearRect","mapUrl","onImageLoadCallback","img","Image","src","onload","complete","drawImage","onMapSWitchClick","origin","leftBottomX","leftBottomY","height","zoomScale","width","text","logoUrl","dottedSize","font","fillText","mounted","robotStatus","resultNotify","watch","newVal","oldVal","clearInterval"],"sourceRoot":"","sources":["D:\\Program Files\\web\\prj\\sendRobot\\src\\pages\\Dashboard\\components\\MapDashboard.vue"],"sourcesContent":["<template>\n  <div>\n    <div>\n      <div>\n        <div class=\"map-header\">\n          <div>\n            <span>地图列表</span>\n            <el-select\n              v-model=\"currentMap\"\n              class=\"m-2\"\n              placeholder=\"Select\"\n              size=\"large\"\n              style=\"margin-left: 10px\"\n            >\n              <el-option\n                v-for=\"(item, index) in mapList\"\n                :key=\"index\"\n                :label=\"item\"\n                :value=\"item\"\n              />\n            </el-select>\n            <el-button type=\"primary\" @click=\"changeMap\">切换地图</el-button>\n          </div>\n          <el-dialog\n            v-model=\"dialogVisible\"\n            title=\"Tips\"\n            width=\"30%\"\n          >\n            <span>确认切换地图吗？</span>\n            <template #footer>\n              <span class=\"dialog-footer\">\n                <el-button @click=\"dialogVisible = false\">取消</el-button>\n                <el-button type=\"primary\" @click=\"comfireModel\"\n                  >确认</el-button\n                >\n              </span>\n            </template>\n          </el-dialog>\n          <div>当前地图：{{ this.robotInfo.map }}</div>\n\n          <!-- <div\n            v-for=\"(i, index) in mapList\"\n            :key=\"i\"\n            @click=\"onMapSWitchClick(i)\"\n            :class=\"currentMap === i ? 'map-radio select' : 'map-radio'\"\n            :style=\"{\n              marginBottom: index === mapList.length - 1 ? 0 : '5px',\n            }\"\n          >\n            {{ i }}\n          </div> -->\n        </div>\n      </div>\n      <div className=\"map-container\" id=\"map-container\">\n        <canvas\n          id=\"map\"\n          :width=\"canvasWidth\"\n          :height=\"canvasHeight\"\n          style=\"border: 1px solid #ccc\"\n        ></canvas>\n        <div class=\"state-box\">\n          <ul>\n            <li>机器人状态：</li>\n            <li>机械臂处于原点：</li>\n            <li>AGV状态：</li>\n            <li>定位是否准确：</li>\n            <li>急停：</li>\n            <li>前方阻挡：</li>\n            <li>当前电量：</li>\n          </ul>\n        </div>\n      </div>\n    </div>\n    <div class=\"map-footer\">\n      <span>目标站点</span>\n      <el-select\n        v-model=\"selectedPosition\"\n        class=\"m-2\"\n        placeholder=\"Select\"\n        size=\"large\"\n        style=\"margin-left: 10px\"\n      >\n        <el-option\n          v-for=\"item in positionsList\"\n          :key=\"item.id\"\n          :label=\"positionType[item.type]\"\n          :value=\"item.id\"\n        />\n      </el-select>\n      <el-button type=\"primary\" @click=\"onNavClick\">导航</el-button>\n      <el-button type=\"primary\" @click=\"rediretorPosition\">重定位</el-button>\n    </div>\n    <!-- <div className=\"right-area\">\n        <RobotOperation\n          :positionsList=\"positionsList\"\n          :drawPoint=\"drawPoint\"\n          :calculatePointPosition=\"calculatePointPosition\"\n          :initRobotInfo=\"robotInfo\"\n        />\n      </div> -->\n  </div>\n</template>\n\n<script>\n/* eslint-disable no-unused-vars */\nimport { ElMessage } from \"element-plus\";\nimport RobotOperation from \"./RobotOperation.vue\";\nimport {\n  getMapList,\n  switchMap,\n  getMapInfo,\n  getPositions,\n  registerCallbackApi,\n} from \"@/service/map\";\nimport { getRobotInfoApi, robotNavigationApi } from \"@/service/robot\";\nexport default {\n  name: \"MapDashboard\",\n  // eslint-disable-next-line vue/no-unused-components\n  components: { RobotOperation },\n  data() {\n    return {\n      dialogVisible:false,\n      selectedPosition: \"\",\n      defaultMap: require(\"@/assets/images/defaulmap.jpg\"),\n      logo: require(\"@/assets/logo.png\"),\n      robotLogo: require(\"@/assets/images/robot.png\"),\n      canvasWidth: 1000, //1200\n      canvasHeight: 500, //600\n      count: 0, // 用来记录机器人的位置是否连续5次一样，5次一样的话停止轮询\n      mapList: [],\n      currentMap: \"\",\n      mapLoading: false,\n      mapInfo: {},\n      positionsList: [],\n      robotInfo: {},\n      positionType: {\n        NAV_POS_TYPE: \"导航点位\",\n        PARK_POS_TYPE: \"停车点位\",\n        CHARGE_POS_TYPE: \"充电点位\",\n        ACTION_POS_TYPE: \"工作点位\",\n      },\n      canvasCtx: \"\",\n    };\n  },\n  methods: {\n    changeMap(){\n      this.dialogVisible = true\n    },\n    comfireModel(){\n      //确认切换地图\n      this.getMapInfo(this.currentMap)\n    },\n    startPolling() {\n      this.polling = setInterval(() => {\n        this.getMapInfo(this.currentMap);\n      }, 3000); // 3秒查询一次\n    },\n    async onNavClick() {\n      if (this.selectedPosition) {\n        const res = await robotNavigationApi({\n          destPosition: this.selectedPosition,\n          cmd: 0,\n        });\n        const { data, code } = res;\n        // this.currentNavRequestId = data.requestId;\n        if (code === 0) {\n          ElMessage({\n            message: `导航开始，当前目标点：${\n              this.positionsList.find((i) => i.id === this.selectedPosition)\n                .type\n            }`,\n            type: \"success\",\n          });\n          this.startPolling();\n        }\n      } else {\n        ElMessage({\n          message: `请先选择一个导航点`,\n          type: \"warning\",\n        });\n      }\n    },\n    async getCurrentRobotInfo() {\n      const { data } = await getRobotInfoApi();\n      this.robotInfo = data;\n      if (data.map === this.currentMap) {\n        const { x, y } = this.calculatePointPosition(data.x, data.y);\n        // 渲染机器人位置\n        this.drawPoint(this.robotInfo.robotId, this.robotLogo, x, y, 40);\n      }\n    },\n    async getMapList() {\n      const { data } = await getMapList();\n      console.log(\"data\", data);\n      this.mapList = data.mapList;\n      this.currentMap = data.currentMap;\n    },\n    async getMapInfo(mapName) {\n      const { data } = await getMapInfo({\n        mapName,\n        containPixelData: false,\n      });\n      console.log(\"MapInfo\",data)\n      this.mapInfo = data;\n      // 获取到地图数据后渲染地图和相关位置点\n      if (this.mapList.length > 0) {\n        this.drawMap(data.mapFile, () => {\n          this.getMapPositions();\n        });\n      }\n    },\n    async getMapPositions() {\n      const { data } = await getPositions();\n      this.positionsList = data.posArray;\n      this.getCurrentRobotInfo();\n      data.posArray.forEach((item) => {\n        const { x, y } = this.calculatePointPosition(item.x, item.y);\n        // 渲染地图上的点\n        this.drawPoint(this.positionType[item.type], this.logo, x, y, 20);\n      });\n    },\n    getCanvasCtx() {\n      const map = document.getElementById(\"map\");\n      const ctx = map.getContext(\"2d\");\n      this.canvasCtx = ctx;\n    },\n    clearCanvas() {\n      // TODO 目前是清空整个canvas重绘 后续可以针对某个点清空重绘？\n      this.canvasCtx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);\n    },\n    drawMap(mapUrl, onImageLoadCallback) {\n      const img = new Image();\n      img.src = mapUrl;\n      //  加载图片\n      img.onload = () => {\n        if (img.complete) {\n          this.canvasCtx.drawImage(\n            img,\n            0,\n            0,\n            this.canvasWidth,\n            this.canvasHeight\n          );\n          if (onImageLoadCallback) {\n            onImageLoadCallback();\n          }\n        }\n      };\n    },\n    async onMapSWitchClick(map) {\n      const { code } = await switchMap({ mapName: map });\n      if (code === 0) {\n        this.currentMap = map;\n      }\n    },\n    calculatePointPosition(x, y) {\n      // 给的是地图左下角的点，canvas原点在左上角\n      const origin = {\n        x: this.mapInfo.leftBottomX,\n        y: this.mapInfo.leftBottomY - this.mapInfo.height,\n      };\n      // 缩放倍数\n      const zoomScale = {\n        x: this.canvasWidth / this.mapInfo.width,\n        y: this.canvasHeight / this.mapInfo.height,\n      };\n      return {\n        x: (x - origin.x) * zoomScale.x,\n        y: (y - origin.y) * zoomScale.y,\n      };\n    },\n    drawPoint(text, logoUrl, x, y, dottedSize) {\n      const img = new Image();\n      img.src = logoUrl;\n      //  加载图片\n      img.onload = () => {\n        if (img.complete) {\n          this.canvasCtx.drawImage(img, x, y, dottedSize, dottedSize);\n          this.canvasCtx.font = \"12px bold 黑体\";\n          this.canvasCtx.fillText(text, x + dottedSize, y + dottedSize);\n          // if (onImageLoadCallback) {\n          //   onImageLoadCallback();\n          // }\n        }\n      };\n    },\n  },\n  mounted() {\n    registerCallbackApi({\n      robotStatus: \"/robotStatus\",\n      resultNotify: \"/resultNotify\",\n    });\n    this.getMapList();\n    this.getCanvasCtx();\n    this.drawMap(this.defaultMap);\n  },\n  watch: {\n    currentMap(newVal) {\n      this.getMapInfo(newVal);\n    },\n    robotInfo(newVal, oldVal) {\n      // 如果位置五次都一样，停止轮询\n      if (newVal.x === oldVal.x && newVal.y === oldVal.y) {\n        this.count += 1;\n        if (this.count > 5) {\n          clearInterval(this.polling);\n          this.polling = null;\n        }\n      }\n    },\n  },\n};\n</script>\n\n<style scoped>\n.map-container {\n  width: \"100%\";\n}\n.dashboard-container {\n  display: flex;\n  /* justify-content: space-between; */\n}\n.map-header {\n  width: 1200px;\n  display: flex;\n  align-items: center;\n  /* justify-content: space-between; */\n  margin-bottom: 10px;\n}\n.map-radio {\n  border: 1px solid #f0f0f0;\n  padding: 5px 14px;\n  cursor: pointer;\n}\n.map-radio:hover {\n  border: 1px solid #adbbff;\n  color: #adbbff;\n}\n.map-radio.select {\n  border: 1px solid #6882ff;\n  color: #6882ff;\n}\n.state-box {\n  position: absolute;\n  top: 100px;\n  right: 130px;\n  width: 228px;\n  height: 600px;  \n  background: #FBFDFF;\nbox-shadow: -2px 0px 4px rgba(0, 0, 0, 0.12);\nborder-radius: 6px 0px 0px 6px;\n}\n.state-box ul {\n  list-style: none;\n  line-height: 50px;\n}\n.el-button.el-button--primary {\n  margin-left: 20px;\n  margin-right: 20px;\n}\n.map-footer {\n  margin-top: 20px;\n}\n</style>"]},"metadata":{},"sourceType":"module"}